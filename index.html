<!DOCTYPE html>
<html lang="en">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Sales Visit App</title>

<!-- Lottie -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bodymovin/5.8.1/lottie.min.js"></script>

<style>
/* RESET */
body { margin:0; font-family: 'Segoe UI', sans-serif; background:#f5f5f5; }

/* DARK MODE */
body.dark { background:#1c1c1c; color:#fff; }

/* Slide Menu */
#menu {
  width:250px; background:#222; color:white;
  height:100vh; position:fixed; top:0; left:-250px;
  transition:0.4s; padding:20px;
}
#menu.open { left:0; }
.menu-item { padding:12px; cursor:pointer; }

/* Header */
.header {
  display:flex; align-items:center; padding:10px;
  background:#007BFF; color:white;
}
.menu-icon { font-size:22px; cursor:pointer; margin-right:10px; }
.logout-btn {
  margin-left:auto; background:#ff4d4d; border:none;
  padding:5px 10px; border-radius:5px; color:white;
}

/* Container */
.container { padding:15px; }

/* Dashboard */
.dashboard {
  padding:10px; background:white; border-radius:10px;
  margin-bottom:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1);
}

/* Form */
input, select, button {
  width:100%; padding:10px; margin-top:10px;
  border-radius:8px; border:1px solid #ccc;
}
button { background:#007bff; color:white; font-weight:bold; border:none; }

/* Loading Overlay */
#loadingScreen {
  position:fixed; inset:0; background:white;
  display:flex; justify-content:center; align-items:center;
}
</style>
</head>

<body>

<!-- Loading Screen -->
<div id="loadingScreen">
  <div id="loadingAnimation" style="width:150px;height:150px;"></div>
</div>

<!-- Side Menu -->
<div id="menu">
  <div class="menu-item" onclick="toggleDark()">ðŸŒ™ Toggle Dark Mode</div>
</div>

<!-- Header -->
<div class="header">
  <div class="menu-icon" onclick="toggleMenu()">â˜°</div>
  <span id="welcomeText"></span>
  <button class="logout-btn" onclick="logout()">Logout</button>
</div>

<div class="container">

  <!-- Dashboard -->
  <div class="dashboard">
    <h3>My Dashboard</h3>
    <b>Visits MTD:</b> <span id="dVisits">0</span><br>
    <b>Shops Sold:</b> <span id="dSold">0</span><br>
    <b>Efficiency:</b> <span id="dEff">0%</span><br>
    <b>Cartons Sold:</b> <span id="dCartons">0</span>
  </div>

  <!-- FORM -->
  <form id="visitForm">

    <label>Region</label>
    <select id="region">
      <option>Mvita</option>
      <option>Nyali</option>
      <option>Kisauni</option>
      <option>Likoni</option>
      <option>Jomvu</option>
      <option>Changamwe</option>
    </select>

    <label>Shop Name</label>
    <input type="text" id="shopName">

    <label>Sold?</label>
    <select id="sold" onchange="toggleSold()">
      <option value="">Select</option>
      <option>Yes</option>
      <option>No</option>
    </select>

    <div id="soldFields" style="display:none;">
      <label>Cartons</label>
      <input type="number" id="cartons">

      <label>SKU</label>
      <select id="sku">
        <option>Beef</option>
        <option>Chicken</option>
        <option>Supa Mojo</option>
      </select>
    </div>

    <div id="noFields" style="display:none;">
      <label>Reason</label>
      <select id="reason">
        <option>Financial Constraint</option>
        <option>Not Moving</option>
        <option>Prefers Competitor</option>
        <option value="other">Other...</option>
      </select>
      <input type="text" id="reasonOther" style="display:none;" placeholder="Type reason">
    </div>

    <label>Selfie</label>
    <video id="camera" width="200" autoplay></video>
    <canvas id="preview" width="200" height="200"></canvas>
    <button type="button" onclick="capture()">Capture</button>

    <button type="submit">Submit Visit</button>
  </form>

  <p id="successMsg" style="color:green; font-weight:bold;"></p>

</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxPuK8Vwl30zuyrutpLZfu81LYjPzPMUPCFBNxWzL-w5grgcx0vDtMBp9l5WJRuj2cC/exec";

// ------------- LOTTIE LOADING -------------
lottie.loadAnimation({
  container: document.getElementById("loadingAnimation"),
  renderer: "svg",
  loop: true,
  autoplay: true,
  path: "https://lottie.host/b7bdbe9a-Loading.json"
});

setTimeout(() => { document.getElementById("loadingScreen").style.display="none"; }, 1500);

// --------- LOCAL STORAGE LOGIN ----------
let user = JSON.parse(localStorage.getItem("user"));
if (!user) window.location.href = "login.html";

document.getElementById("welcomeText").innerText = "Welcome " + user.name;

// --------- MENU ----------
function toggleMenu(){ document.getElementById("menu").classList.toggle("open"); }
function toggleDark(){ document.body.classList.toggle("dark"); }

// --------- SOLD TOGGLE ----------
function toggleSold() {
  const sold = document.getElementById("sold").value;
  document.getElementById("soldFields").style.display = sold==="Yes" ? "block":"none";
  document.getElementById("noFields").style.display = sold==="No" ? "block":"none";
}

// --------- SELFIE ----------
navigator.mediaDevices.getUserMedia({ video:true }).then(stream=>{
  camera.srcObject = stream;
});

function capture(){
  const ctx = preview.getContext("2d");
  ctx.drawImage(camera,0,0,200,200);
}

// --------- FORM SUBMIT ----------
document.getElementById("visitForm").addEventListener("submit", async(e)=>{
  e.preventDefault();

  const pos = await new Promise(res=>{
    navigator.geolocation.getCurrentPosition(res);
  });

  const selfie = preview.toDataURL();

  const payload = {
    action: "submitVisit",
    userId: user.id,
    name: user.name,
    region: region.value,
    shopName: shopName.value,
    sold: sold.value,
    cartons: cartons.value,
    sku: sku.value,
    reason: reason.value === "other" ? reasonOther.value : reason.value,
    latitude: pos.coords.latitude,
    longitude: pos.coords.longitude,
    selfieBase64: selfie
  };

  const r = await fetch(API_URL, { method:"POST", body:JSON.stringify(payload) });
  const json = await r.json();

  if (json.success){
    document.getElementById("successMsg").innerText = 
      "The sales visit has been successfully submitted";
  }
});

// --------- DASHBOARD LOAD ----------
async function loadDashboard(){
  const r = await fetch(API_URL, {
    method:"POST",
    body:JSON.stringify({ action:"getDashboard", userId:user.id })
  });
  const j = await r.json();

  dVisits.innerText = j.visits;
  dSold.innerText = j.soldShops;
  dEff.innerText = j.efficiency + "%";
  dCartons.innerText = j.cartons;
}
loadDashboard();

// --------- LOGOUT ----------
function logout(){
  localStorage.clear();
  location.href="login.html";
}
</script>
</body>
</html>
