<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sales Visit App</title>

<!-- Bootstrap 5 -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

<style>
 :root{
  --primary: #d90429;
  --primary-dark: #a4031f;
  --bg: #fbfafc;
  --text: #111;
  --card-radius: 14px;
  --shadow: 0 6px 20px rgba(0,0,0,0.08);
 }

 .dark {
  --bg: #0f1113;
  --text: #e9ecef;
  --shadow: 0 6px 20px rgba(0,0,0,0.3);
 }

 body{
  background:var(--bg);
  color:var(--text);
  font-family:"Segoe UI", system-ui, -apple-system, "Helvetica Neue", Arial;
  margin:0; padding-bottom:80px;
 }

 /* top heading bar */
 #topHeading {
  background: var(--primary);
  color:#fff;
  padding:10px 14px;
  border-radius:12px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin:10px 0 16px 0;
 }

 #centerTitle {
  position:absolute;
  left:50%;
  transform:translateX(-50%);
  font-size:17px;
  font-weight:600;
 }

 #topHeading .dateText {
   font-size:15px;
   font-weight:600;
 }

 #topHeading .rightControls {
   display:flex;
   align-items:center;
   gap:10px;
 }

 .dark-toggle{
  background: rgba(255,255,255,0.12);
  color:#fff;
  border-radius:10px;
  padding:6px 8px;
  cursor:pointer;
  border:none;
 }

 #logoutBtn2{
  background: rgba(255,255,255,0.12);
  border:none;
  color:#fff;
  padding:6px 10px;
  border-radius:10px;
  font-size:16px;
  display:flex;
  align-items:center;
 }

 .container-root{
  max-width:760px;
  margin:16px auto;
  padding:0 12px;
 }

 .card-custom{ background:#fff; border-radius:var(--card-radius); padding:16px; box-shadow:var(--shadow); margin-bottom:14px; color:var(--text); }
 .dark .card-custom{ background:#121416; }

 label{ font-size:13px; color:#444; margin-bottom:6px; display:block; }
 .small-muted{ font-size:13px; color:#777; }

 .sku-item{ display:flex; align-items:center; justify-content:space-between; padding:8px 6px; border-radius:10px; margin-bottom:8px; background:#fff6f6; }
 .qty-buttons button{ width:34px; height:34px; border-radius:8px; border:none; background:var(--primary); color:#fff; font-size:18px; }

 #camera{ width:100%; height:220px; border-radius:12px; background:#f0f0f0; object-fit:cover; }
 #preview{ width:120px; height:120px; object-fit:cover; border-radius:12px; }

 .success-overlay{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.35); z-index:2000; opacity:0; pointer-events:none; transition:opacity .25s; }
 .success-overlay.show{ opacity:1; pointer-events:auto; }

 .check{ width:88px; height:88px; border-radius:50%; border:6px solid #e9e9e9; margin:0 auto 12px; }
 .check i{ font-size:44px; color:var(--primary); margin-top:14px; }

 @media(max-width:480px){
  #camera{ height:160px; }
  #topHeading .dateText { font-size:13px; }
 }
</style>
</head>
<body>

<!-- SUCCESS OVERLAY -->
<div id="successOverlay" class="success-overlay">
  <div class="success-box card-custom" style="text-align:center; max-width:260px;">
    <div class="check"><i class="bi bi-check-lg"></i></div>
    <h5>Successfully submitted visit</h5>
  </div>
</div>

<div class="container-root">

  <!-- LOGIN CARD -->
  <div id="loginCard" class="card-custom">
    <h4 style="text-align:center;">Sales Visit App</h4>
    <p class="small-muted text-center">Enter your National ID and password.</p>

    <label>National ID</label>
    <input id="idInput" class="form-control" type="text">

    <label class="mt-3">Password</label>
    <input id="passInput" class="form-control" type="password">

    <button class="btn btn-danger w-100 mt-3" onclick="login()">Login</button>
  </div>

  <!-- MAIN UI -->
  <div id="mainUI" style="display:none;">

    <!-- TOP BAR WITH CENTERED TITLE -->
    <div id="topHeading">
      <div class="dateText" id="headingDate"></div>

      <div id="centerTitle">Sales Visit App</div>

      <div class="rightControls">
        <button id="darkToggle" class="dark-toggle"><i id="darkIcon" class="bi bi-moon"></i></button>

        <button id="logoutBtn2" onclick="logout()">
          <i class="bi bi-box-arrow-right"></i>
        </button>
      </div>
    </div>

    <!-- DASHBOARD CARD -->
    <div class="card-custom">
      <div class="d-flex justify-content-between">
        <div>
          <div class="small-muted">Month-to-date</div>
          <h5>Your Analytics</h5>
        </div>

        <div class="text-end small-muted" id="userInfo"></div>
      </div>

      <div class="small-muted mt-2">
        Visits: <strong id="vMTD">0</strong><br>
        Sold: <strong id="sMTD">0</strong><br>
        Cartons: <strong id="cMTD">0</strong><br>
        Efficiency: <strong id="eMTD">0%</strong>
      </div>
    </div>

    <!-- FORM CARD -->
    <div class="card-custom">

      <form id="visitForm" onsubmit="return handleSubmit(event)">

        <label>Region</label>
        <select id="region" class="form-select" required>
          <option value="">Select region</option>
          <option>Mvita</option>
          <option>Nyali</option>
          <option>Kisauni</option>
          <option>Likoni</option>
          <option>Changamwe</option>
          <option>Jomvu</option>
        </select>

        <label class="mt-3">Shop Name</label>
        <input id="shop" class="form-control" required>

        <label class="mt-3">Sold?</label>
        <select id="sold" onchange="handleSoldChange()" class="form-select" required>
          <option value="">Select</option>
          <option>Yes</option>
          <option>No</option>
        </select>

        <!-- SKUs -->
        <div id="skuSection" style="display:none;" class="mt-3">
          <label><strong>Select SKU & quantity</strong></label>
          <div id="skuList" class="mt-2"></div>
        </div>

        <!-- Reason -->
        <div id="reasonSection" style="display:none;" class="mt-3">
          <label>Reason for not selling</label>
          <select id="reason" onchange="toggleOtherReason()" class="form-select">
            <option value="">Select</option>
            <option>Financial Constraint</option>
            <option>Not Moving</option>
            <option>Prefers Competitor Product</option>
            <option>Other</option>
          </select>
          <input id="otherReason" class="form-control mt-2" style="display:none" placeholder="Specify reason">
        </div>

        <!-- Selfie -->
        <label class="mt-3">Selfie</label>
        <video id="camera" autoplay muted playsinline></video>

        <div class="d-flex gap-2 mt-2">
          <button type="button" class="btn btn-secondary" onclick="capture()">Capture</button>
          <img id="preview" src="">
        </div>

        <button type="submit" class="btn btn-danger w-100 mt-4">Submit Visit</button>

      </form>
    </div>
  </div>
</div>

<script>
const backend = "https://script.google.com/macros/s/AKfycbxPuK8Vwl30zuyrutpLZfu81LYjPzPMUPCFBNxWzL-w5grgcx0vDtMBp9l5WJRuj2cC/exec";

let currentUser = null;
let selfieData = "";
let coords = { latitude:"", longitude:"" };

const availableSKUs = ["Chicken","Beef","Supa Mojo"];
let skuQuantities = {};
availableSKUs.forEach(k => skuQuantities[k] = 0);

/* Format date */
function formatHeadingDate(){
  const d = new Date();
  const day = d.toLocaleDateString("en-GB",{ weekday:"short" });
  const dd = String(d.getDate()).padStart(2,"0");
  const mon = d.toLocaleDateString("en-GB",{ month:"short" });
  const y = d.getFullYear();
  return `${day} ${dd}/${mon}/${y}`;
}
document.getElementById("headingDate").textContent = formatHeadingDate();

/* Restore session */
window.onload = () => {
  const saved = localStorage.getItem("userSession");
  if(saved){
    currentUser = JSON.parse(saved);
    loginCard.style.display = "none";
    mainUI.style.display = "block";
    userInfo.innerHTML = `${currentUser.name}<br>${currentUser.nationalID}`;
    startCamera();
    renderSKUList();
    loadDashboard();
  }
};

/* Dark Mode */
document.getElementById("darkToggle").onclick = () => {
  document.body.classList.toggle("dark");
  const icon = document.getElementById("darkIcon");
  icon.className = document.body.classList.contains("dark") ? "bi bi-sun" : "bi bi-moon";
};

/* Login */
async function login(){
  const nationalID = idInput.value.trim();
  const password = passInput.value;

  if(!nationalID || !password){
    alert("Enter National ID & Password");
    return;
  }

  const res = await fetch(backend,{
    method:"POST",
    body:JSON.stringify({ action:"login", nationalID, password })
  });

  const data = await res.json();
  if(!data.success){ alert("Invalid credentials"); return; }

  currentUser = data;
  localStorage.setItem("userSession", JSON.stringify(data));

  userInfo.innerHTML = `${data.name}<br>${data.nationalID}`;

  mainUI.style.display = "block";
  loginCard.style.display = "none";

  startCamera();
  renderSKUList();
  loadDashboard();
}

/* Dashboard */
async function loadDashboard(){
  const r = await fetch(backend,{
    method:"POST",
    body:JSON.stringify({ action:"dashboard", nationalID: currentUser.nationalID })
  });
  const d = await r.json();
  vMTD.textContent = d.visitsMTD;
  sMTD.textContent = d.soldMTD;
  cMTD.textContent = d.cartonsMTD;
  eMTD.textContent = d.efficiency + "%";
}

/* Camera */
async function startCamera(){
  const stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:"user" }});
  camera.srcObject = stream;
}

function capture(){
  const canvas = document.createElement("canvas");
  canvas.width = 120; canvas.height = 120;
  canvas.getContext("2d").drawImage(camera,0,0,120,120);
  selfieData = canvas.toDataURL("image/png");
  preview.src = selfieData;
}

/* SKU */
function renderSKUList(){
  skuList.innerHTML = "";
  availableSKUs.forEach(sku=>{
    const id = sku.replace(/\s+/g,"_");
    skuList.innerHTML += `
      <div class="sku-item">
        <strong>${sku}</strong>
        <div class="qty-buttons">
          <button type="button" onclick="changeQty('${sku}',-1)">-</button>
          <span id="qty-${id}" style="padding:0 10px;">0</span>
          <button type="button" onclick="changeQty('${sku}',1)">+</button>
        </div>
      </div>`;
  });
}

function changeQty(sku,delta){
  skuQuantities[sku] = Math.max(0,(skuQuantities[sku]||0)+delta);
  document.getElementById("qty-"+sku.replace(/\s+/g,"_")).textContent = skuQuantities[sku];
}

/* Sold change */
function handleSoldChange(){
  const v = sold.value;
  skuSection.style.display = v==="Yes"?"block":"none";
  reasonSection.style.display = v==="No"?"block":"none";
}

function toggleOtherReason(){
  otherReason.style.display = reason.value==="Other"?"block":"none";
}

/* Auto-capture location */
function autoCaptureLocation(){
  return new Promise((resolve,reject)=>{
    navigator.geolocation.getCurrentPosition(
      pos => {
        coords.latitude = pos.coords.latitude;
        coords.longitude = pos.coords.longitude;
        resolve();
      },
      err => reject("Location failed"),
      { enableHighAccuracy:true, timeout:6000 }
    );
  });
}

/* Submit */
async function handleSubmit(e){
  e.preventDefault();
  if(!selfieData){ alert("Capture selfie"); return; }

  try{
    await autoCaptureLocation();
  }catch(e){
    alert("Enable GPS to continue.");
    return;
  }

  const region = document.getElementById("region").value.trim();
  const shop = document.getElementById("shop").value.trim();
  const soldV = sold.value;

  let skusPayload=[];
  if(soldV==="Yes"){
    availableSKUs.forEach(k=>{
      const q=skuQuantities[k];
      if(q>0) skusPayload.push({ name:k, qty:q });
    });
    if(skusPayload.length===0){ alert("Select SKU quantity"); return; }
  }

  let reasonVal="";
  if(soldV==="No"){
    const r = reason.value;
    if(!r){ alert("Select reason"); return; }
    reasonVal = r==="Other" ? otherReason.value.trim() : r;
    if(r==="Other" && !reasonVal){ alert("Specify reason"); return; }
  }

  const payload = {
    action:"saveVisit",
    record:{
      nationalID: currentUser.nationalID,
      name: currentUser.name,
      region, shopName: shop,
      sold: soldV,
      skus: skusPayload,
      reason: reasonVal,
      longitude: coords.longitude,
      latitude: coords.latitude,
      selfie:selfieData
    }
  };

  await fetch(backend,{ method:"POST", body:JSON.stringify(payload) });

  showSuccess();

  visitForm.reset();
  selfieData="";
  preview.src="";
  skuQuantities = { Chicken:0, Beef:0, "Supa Mojo":0 };
  renderSKUList();
  loadDashboard();
}

/* Success Box */
function showSuccess(){
  successOverlay.classList.add("show");
  setTimeout(()=> successOverlay.classList.remove("show"),1600);
}

/* Logout */
function logout(){
  localStorage.removeItem("userSession");
  location.reload();
}
</script>

</body>
</html>
